---
import Logo from "./Logo.astro";

const navigation = [
  { label: "Home", url: "/" },
  { label: "Projects", url: "/#projects-list-start" },
  { label: "About", url: "/about" },
];

const normalize = (p: string) => {
  if (!p) return "/";
  return p !== "/" && p.endsWith("/") ? p.slice(0, -1) : p;
};

const currentPath = normalize(Astro.url.pathname);

const isActive = (itemUrl: string) => {
  const u = new URL(itemUrl, Astro.url);
  const itemPath = normalize(u.pathname);
  const hasHash = !!u.hash;

  if (hasHash) {
    return currentPath === "/" && Astro.url.hash === u.hash;
  }

  if (itemPath === "/") {
    return currentPath === "/";
  }

  return currentPath === itemPath || currentPath.startsWith(itemPath + "/");
};
---

<header class="sticky top-0 z-50 py-4" data-header>
  <div class="container-wide">
    <nav id="nav" class="nav-pill" data-nav>
      <div class="flex items-center">
        <Logo />
      </div>

      <ul class="flex items-center gap-1 list-none p-0 m-0 max-md:hidden">
        {
          navigation.map((item) => {
            const u = new URL(item.url, Astro.url);
            const isHashLink = !!u.hash;
            const shouldBeActive = isActive(item.url);

            return (
              <li>
                <a
                  href={item.url}
                  data-nav-link
                  data-hash={isHashLink ? u.hash.slice(1) : null}
                  aria-current={shouldBeActive ? "page" : undefined}
                  class:list={["nav-link", { "is-active": shouldBeActive }]}
                >
                  {item.label}
                  <span class="nav-underline" data-nav-indicator />
                </a>
              </li>
            );
          })
        }
      </ul>

      <div class="flex items-center gap-2">
        <button id="cmdk-button" class="search-btn" data-magnetic>
          <span>Search</span>
          <kbd class="kbd max-md:hidden">K</kbd>
        </button>

        <button
          class="mobile-menu-btn"
          id="mobile-menu-btn"
          aria-label="Toggle menu"
          aria-expanded="false"
        >
          <span class="bar" data-bar-1></span>
          <span class="bar" data-bar-2></span>
          <span class="bar" data-bar-3></span>
        </button>
      </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu md:hidden" id="mobile-menu" aria-hidden="true">
      <ul class="flex flex-col gap-2 list-none p-0 m-0 mt-20">
        {
          navigation.map((item) => {
            const u = new URL(item.url, Astro.url);
            const isHashLink = !!u.hash;
            const shouldBeActive = isActive(item.url);

            return (
              <li>
                <a
                  href={item.url}
                  data-nav-link-mobile
                  data-hash={isHashLink ? u.hash.slice(1) : null}
                  aria-current={shouldBeActive ? "page" : undefined}
                  class:list={["mobile-nav-link", { "is-active": shouldBeActive }]}
                >
                  {item.label}
                </a>
              </li>
            );
          })
        }
      </ul>
    </div>

    <div id="mobile-menu-overlay" class="mobile-overlay md:hidden" aria-hidden="true"></div>
  </div>
</header>

<script>
  import { gsap } from "gsap";

  document.addEventListener("astro:page-load", () => {
    const btn = document.getElementById("cmdk-button");
    const header = document.querySelector("[data-header]");
    const nav = document.querySelector("[data-nav]");
    const mobileBtn = document.getElementById("mobile-menu-btn");
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileOverlay = document.getElementById("mobile-menu-overlay");

    const open = () => {
      window.dispatchEvent(new CustomEvent("open-command-palette"));
    };

    btn?.addEventListener("click", open);

    const onKey = (e: KeyboardEvent) => {
      const hasKey = e.key?.toLowerCase() === "k";
      if ((e.metaKey && hasKey) || (e.ctrlKey && hasKey)) {
        e.preventDefault();
        open();
      }
    };

    window.addEventListener("keydown", onKey, { passive: false });

    // Scroll effect - add shadow on scroll
    if (header && nav && !window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
      const onScroll = () => {
        const scrolled = window.pageYOffset > 50;
        nav.classList.toggle("is-scrolled", scrolled);
      };

      window.addEventListener("scroll", onScroll, { passive: true });
      onScroll();
    }

    const normalizePath = (p: string) => {
      if (!p) return "/";
      return p !== "/" && p.endsWith("/") ? p.slice(0, -1) : p;
    };

    const computeActive = (href: string) => {
      const u = new URL(href, window.location.origin);
      const currentPath = normalizePath(window.location.pathname);
      const itemPath = normalizePath(u.pathname);
      const hasHash = !!u.hash;

      if (hasHash) {
        return currentPath === "/" && window.location.hash === u.hash;
      }

      if (itemPath === "/") return currentPath === "/";
      return currentPath === itemPath || currentPath.startsWith(itemPath + "/");
    };

    const updateActiveStates = () => {
      const links = document.querySelectorAll("[data-nav-link], [data-nav-link-mobile]");
      links.forEach((link) => {
        if (!(link instanceof HTMLElement)) return;

        const href = link.getAttribute("href") || "";
        const active = computeActive(href);

        if (active) {
          link.setAttribute("aria-current", "page");
          link.classList.add("is-active");
        } else {
          link.removeAttribute("aria-current");
          link.classList.remove("is-active");
        }
      });
    };

    window.addEventListener("hashchange", updateActiveStates);

    let ticking = false;
    const onScrollForSections = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const sections = document.querySelectorAll("[id]");
          const scrollPos = window.pageYOffset + 100;

          sections.forEach((section) => {
            const top = (section as HTMLElement).offsetTop;
            const height = (section as HTMLElement).offsetHeight;
            const id = section.getAttribute("id");

            if (scrollPos >= top && scrollPos < top + height) {
              const newHash = `#${id}`;
              if (window.location.hash !== newHash) {
                history.replaceState(null, "", newHash);
                updateActiveStates();
              }
            }
          });

          ticking = false;
        });

        ticking = true;
      }
    };

    window.addEventListener("scroll", onScrollForSections, { passive: true });
    updateActiveStates();

    // Mobile menu toggle
    if (mobileBtn && mobileMenu && mobileOverlay) {
      let isOpen = false;

      const bar1 = mobileBtn.querySelector("[data-bar-1]");
      const bar2 = mobileBtn.querySelector("[data-bar-2]");
      const bar3 = mobileBtn.querySelector("[data-bar-3]");

      const toggleMenu = () => {
        isOpen = !isOpen;

        mobileBtn.setAttribute("aria-expanded", isOpen.toString());
        mobileMenu.setAttribute("aria-hidden", (!isOpen).toString());
        mobileOverlay.setAttribute("aria-hidden", (!isOpen).toString());

        if (isOpen) {
          mobileMenu.classList.add("is-open");
          mobileOverlay.classList.add("is-open");
          document.body.style.overflow = "hidden";

          if (bar1 && bar2 && bar3) {
            gsap.to(bar1, { rotation: 45, y: 6, duration: 0.3, ease: "power2.out" });
            gsap.to(bar2, { opacity: 0, duration: 0.2 });
            gsap.to(bar3, { rotation: -45, y: -6, duration: 0.3, ease: "power2.out" });
          }
        } else {
          mobileMenu.classList.remove("is-open");
          mobileOverlay.classList.remove("is-open");
          document.body.style.overflow = "";

          if (bar1 && bar2 && bar3) {
            gsap.to(bar1, { rotation: 0, y: 0, duration: 0.3, ease: "power2.out" });
            gsap.to(bar2, { opacity: 1, duration: 0.2 });
            gsap.to(bar3, { rotation: 0, y: 0, duration: 0.3, ease: "power2.out" });
          }
        }
      };

      mobileBtn.addEventListener("click", toggleMenu);
      mobileOverlay.addEventListener("click", toggleMenu);

      const mobileLinks = mobileMenu.querySelectorAll("a");
      mobileLinks.forEach((link) => {
        link.addEventListener("click", () => {
          if (isOpen) {
            toggleMenu();
          }
        });
      });
    }

    // Magnetic button effect
    const magneticButtons = document.querySelectorAll("[data-magnetic]");
    const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    if (!prefersReduced) {
      magneticButtons.forEach((btn) => {
        if (!(btn instanceof HTMLElement)) return;

        btn.addEventListener("mouseenter", () => {
          gsap.to(btn, { scale: 1.05, duration: 0.3, ease: "power2.out" });
        });

        btn.addEventListener("mousemove", (e: MouseEvent) => {
          const rect = btn.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          const x = (e.clientX - cx) / 8;
          const y = (e.clientY - cy) / 8;

          gsap.to(btn, {
            x: x,
            y: y,
            duration: 0.3,
            ease: "power2.out",
          });
        });

        btn.addEventListener("mouseleave", () => {
          gsap.to(btn, {
            x: 0,
            y: 0,
            scale: 1,
            duration: 0.4,
            ease: "power2.out",
          });
        });
      });
    }
  });
</script>

<style>
  /* Navigation pill container */
  .nav-pill {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.75rem 1.25rem;
    background: var(--wc-cream);
    border: 1px solid var(--wc-sand);
    border-radius: var(--radius-pill);
    box-shadow: var(--shadow-sm);
    transition:
      box-shadow var(--duration-normal) var(--ease-smooth),
      background var(--duration-normal) var(--ease-smooth);
  }

  .nav-pill.is-scrolled {
    box-shadow: var(--shadow-md);
    background: var(--wc-parchment);
    backdrop-filter: blur(8px);
  }

  /* Navigation links */
  .nav-link {
    position: relative;
    display: inline-block;
    padding: 0.5rem 1rem;
    font-family: var(--font-body);
    font-weight: 500;
    font-size: var(--text-small);
    color: var(--wc-bark);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition:
      color var(--duration-fast) var(--ease-smooth),
      background var(--duration-fast) var(--ease-smooth);
  }

  .nav-link:hover {
    color: var(--wc-accent);
    background: var(--wc-sand);
  }

  .nav-link.is-active {
    color: var(--wc-accent-deep);
  }

  /* Squiggle underline effect */
  .nav-underline {
    position: absolute;
    left: 50%;
    bottom: 4px;
    transform: translateX(-50%);
    width: 0;
    height: 3px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 4'%3E%3Cpath d='M0 2 Q5 0 10 2 T20 2' stroke='%23c4704b' stroke-width='1.5' fill='none'/%3E%3C/svg%3E")
      repeat-x;
    background-size: 20px 4px;
    transition: width var(--duration-normal) var(--ease-bounce);
    transform-origin: center;
  }

  .nav-link:hover .nav-underline,
  .nav-link.is-active .nav-underline {
    width: 80%;
  }

  /* Search button */
  .search-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    font-family: var(--font-body);
    font-size: var(--text-small);
    font-weight: 500;
    color: var(--wc-bark);
    background: transparent;
    border: 1px solid var(--wc-sand);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition:
      color var(--duration-fast) var(--ease-smooth),
      background var(--duration-fast) var(--ease-smooth),
      border-color var(--duration-fast) var(--ease-smooth);
  }

  .search-btn:hover {
    color: var(--wc-accent);
    background: var(--wc-cream);
    border-color: var(--wc-clay);
  }

  /* Mobile menu button */
  .mobile-menu-btn {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 5px;
    padding: 0.5rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background var(--duration-fast) var(--ease-smooth);
  }

  @media (min-width: 768px) {
    .mobile-menu-btn {
      display: none;
    }
  }

  .mobile-menu-btn:hover {
    background: var(--wc-sand);
  }

  .mobile-menu-btn .bar {
    display: block;
    width: 20px;
    height: 2px;
    background: var(--wc-bark);
    border-radius: 1px;
    transition: all var(--duration-normal) var(--ease-smooth);
    transform-origin: center;
  }

  /* Mobile menu panel */
  .mobile-menu {
    position: fixed;
    inset-block: 0;
    right: 0;
    width: 280px;
    padding: 1.5rem;
    background: var(--wc-cream);
    border-left: 1px solid var(--wc-sand);
    box-shadow: -10px 0 40px rgba(44, 36, 28, 0.15);
    transform: translateX(100%);
    transition: transform var(--duration-normal) var(--ease-out);
    z-index: 40;
  }

  .mobile-menu.is-open {
    transform: translateX(0);
  }

  .mobile-nav-link {
    display: block;
    padding: 0.875rem 1rem;
    font-family: var(--font-body);
    font-weight: 500;
    color: var(--wc-bark);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition:
      color var(--duration-fast) var(--ease-smooth),
      background var(--duration-fast) var(--ease-smooth);
  }

  .mobile-nav-link:hover {
    color: var(--wc-accent);
    background: var(--wc-sand);
  }

  .mobile-nav-link.is-active {
    color: var(--wc-accent-deep);
    background: var(--wc-sand);
    border-left: 3px solid var(--wc-accent);
  }

  /* Mobile overlay */
  .mobile-overlay {
    position: fixed;
    inset: 0;
    background: rgba(44, 36, 28, 0.3);
    backdrop-filter: blur(4px);
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--duration-normal) var(--ease-smooth);
    z-index: 30;
  }

  .mobile-overlay.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  /* Focus states */
  .nav-link:focus-visible,
  .mobile-nav-link:focus-visible,
  .search-btn:focus-visible,
  .mobile-menu-btn:focus-visible {
    outline: 2px solid var(--wc-accent);
    outline-offset: 2px;
  }
</style>
