---
import { type CollectionEntry, render } from "astro:content";
import { formatDate } from "../../utils/time";
import SkillChip from "../About/SkillChip.astro";

interface Props {
  project: CollectionEntry<"project">;
}

type ImageType = {
  src: string;
  alt?: string;
};

const { project } = Astro.props;
const { data } = project;
const { name, img, timeline } = data;
const { Content } = await render(project);

const optimizedImages =
  img?.map((image: ImageType) => {
    const needsSlash = typeof image.src === "string" && !image.src.startsWith("/");
    return { ...image, src: needsSlash ? `/${image.src}` : image.src };
  }) || [];

const techStackFromData = data.techStack || [];

const techColorMap: Record<string, string> = {
  React: "#61DAFB",
  TypeScript: "#3178C6",
  Astro: "#FF5D01",
  GSAP: "#88CE02",
  "Three.js": "#000000",
  Vercel: "#000000",
  Docker: "#2496ED",
  "PHP Symfony": "#000000",
  Symfony: "#000000",
  "Node.js": "#339933",
  TailwindCSS: "#06B6D4",
  MySQL: "#4479A1",
  PostgreSQL: "#4169E1",
  Git: "#F05032",
  Linux: "#FCC624",
  GraphQL: "#E10098",
  Tauri: "#000000",
};

const techStack = techStackFromData.map((skill) => ({
  name: skill.name,
  color: skill.color || techColorMap[skill.name] || "#6366F1",
}));
---

<article
  id={`project-${project.id}`}
  class="project-item relative mb-32 last:mb-0"
  data-project-item
>
  <div
    class="absolute left-0 top-0 bottom-0 w-px bg-gradient-to-b from-white/20 via-white/10 to-transparent hidden md:block"
    data-timeline-line
  >
  </div>

  <div
    class="absolute left-[-4px] top-8 w-2 h-2 rounded-full bg-white/80 shadow-lg shadow-white/30 hidden md:block z-10"
    data-timeline-dot
  >
  </div>

  <div class="md:pl-12">
    <header class="mb-6" data-project-header>
      <time
        class="inline-flex items-center gap-2 text-sm font-medium text-white/60 mb-3"
        datetime={timeline.start}
      >
        <span class="w-1.5 h-1.5 rounded-full bg-white/60"></span>
        {
          `${formatDate(new Date(timeline.start))} â€” ${!timeline.end ? "Present" : formatDate(new Date(timeline.end))}`
        }
      </time>

      <h2 class="text-4xl md:text-5xl font-bold text-white tracking-tight mb-4" data-project-title>
        {name}
      </h2>
    </header>

    <div class="space-y-8">
      <div class="prose prose-invert prose-lg max-w-none" data-project-description>
        <Content />
      </div>

      <div class="grid md:grid-cols-12 gap-8 md:gap-12 items-start">
        {
          optimizedImages.length > 0 && (
            <div class="md:col-span-7" data-project-images>
              <div class="space-y-6">
                {optimizedImages.map((image: ImageType, index: number) => (
                  <div
                    class="relative rounded-2xl overflow-hidden p-4"
                    data-project-image-wrapper
                    data-image-index={index}
                  >
                    <div class="relative overflow-hidden">
                      <img
                        src={typeof image.src === "string" ? image.src : ""}
                        alt={image.alt || `${name} screenshot ${index + 1}`}
                        loading="lazy"
                        decoding="async"
                        class="w-full h-full object-cover"
                        data-project-image
                      />
                      <div
                        class="absolute inset-0 bg-gradient-to-br from-white/10 via-transparent to-black/20 opacity-0 transition-opacity duration-500"
                        data-image-overlay
                      />
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )
        }

        {
          techStack.length > 0 && (
            <div
              class={optimizedImages.length > 0 ? "md:col-span-5" : "md:col-span-12"}
              data-tech-section
            >
              <div class="md:sticky md:top-8">
                <h3 class="text-sm font-semibold text-white/50 uppercase tracking-wider mb-4">
                  Tech Stack
                </h3>
                <SkillChip skills={techStack} compact={true} />
              </div>
            </div>
          )
        }
      </div>
    </div>
  </div>
</article>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  document.addEventListener("astro:page-load", () => {
    const projectItems = document.querySelectorAll("[data-project-item]");
    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    if (prefersReducedMotion) {
      return;
    }

    projectItems.forEach((item) => {
      const header = item.querySelector("[data-project-header]");
      const images = item.querySelectorAll("[data-project-image-wrapper]");
      const description = item.querySelector("[data-project-description]");
      const timelineLine = item.querySelector("[data-timeline-line]");
      const timelineDot = item.querySelector("[data-timeline-dot]");

      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: item,
          start: "top 80%",
          end: "bottom 20%",
          toggleActions: "play none none reverse",
        },
      });

      if (timelineLine) {
        tl.fromTo(
          timelineLine,
          { scaleY: 0, transformOrigin: "top" },
          { scaleY: 1, duration: 1, ease: "power2.out" },
          0
        );
      }

      if (timelineDot) {
        tl.fromTo(
          timelineDot,
          { scale: 0, opacity: 0 },
          { scale: 1, opacity: 1, duration: 0.5, ease: "back.out(1.7)" },
          0.3
        );
      }

      if (header) {
        tl.fromTo(
          header.children,
          { opacity: 0, y: 30 },
          { opacity: 1, y: 0, duration: 0.8, stagger: 0.1, ease: "power3.out" },
          0.2
        );
      }

      if (images.length > 0) {
        images.forEach((imgWrapper, imgIndex) => {
          const img = imgWrapper.querySelector("[data-project-image]");
          const overlay = imgWrapper.querySelector("[data-image-overlay]");

          tl.fromTo(
            imgWrapper,
            { opacity: 0, y: 50, scale: 0.95 },
            {
              opacity: 1,
              y: 0,
              scale: 1,
              duration: 1,
              ease: "power3.out",
            },
            0.4 + imgIndex * 0.15
          );

          if (img && overlay) {
            imgWrapper.addEventListener("mouseenter", () => {
              gsap.to(img, { scale: 1.05, duration: 0.6, ease: "power2.out" });
              gsap.to(overlay, { opacity: 1, duration: 0.4 });
            });

            imgWrapper.addEventListener("mouseleave", () => {
              gsap.to(img, { scale: 1, duration: 0.6, ease: "power2.out" });
              gsap.to(overlay, { opacity: 0, duration: 0.4 });
            });
          }
        });
      }

      if (description) {
        tl.fromTo(
          description,
          { opacity: 0, y: 30 },
          { opacity: 1, y: 0, duration: 0.8, ease: "power3.out" },
          0.6
        );
      }

      if (images.length > 0) {
        images.forEach((imgWrapper) => {
          const img = imgWrapper.querySelector("[data-project-image]");
          if (!img) return;

          gsap.to(img, {
            yPercent: 10,
            ease: "none",
            scrollTrigger: {
              trigger: imgWrapper,
              start: "top bottom",
              end: "bottom top",
              scrub: 1,
            },
          });
        });
      }
    });

    const timelineDots = document.querySelectorAll("[data-timeline-dot]");
    timelineDots.forEach((dot) => {
      dot.addEventListener("click", () => {
        const projectItem = dot.closest("[data-project-item]");
        if (projectItem) {
          projectItem.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }
      });
    });
  });
</script>

<style is:global>
  .project-item {
    scroll-margin-top: 2rem;
  }

  .prose-invert {
    --tw-prose-body: rgb(255 255 255 / 0.8);
    --tw-prose-headings: rgb(255 255 255 / 0.95);
    --tw-prose-links: rgb(255 255 255 / 0.9);
    --tw-prose-bold: rgb(255 255 255 / 0.95);
    --tw-prose-code: rgb(255 255 255 / 0.9);
    --tw-prose-quotes: rgb(255 255 255 / 0.85);
  }

  .prose-invert a {
    text-decoration: underline;
    text-underline-offset: 2px;
  }s

  .prose-invert a:hover {
    opacity: 0.8;
  }

  .prose p {
  margin-bottom: 1.25em;
}

.prose ul, .prose ol {
  margin-top: 1em;
  margin-bottom: 1em;
  padding-left: 1.5em;
}

.prose li {
  margin-bottom: 0.5em;
}

  [data-project-image] {
    will-change: transform;
  }

  [data-project-image-wrapper]:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.5);
    outline-offset: 2px;
  }

  @media (max-width: 768px) {
    .project-item {
      scroll-margin-top: 1rem;
    }
  }
</style>
