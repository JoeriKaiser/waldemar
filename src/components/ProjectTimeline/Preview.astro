---
import { Image } from "astro:assets";
import { type CollectionEntry, render } from "astro:content";
import { formatDate } from "../../utils/time";

interface Props {
  project: CollectionEntry<"project">;
}

type ImageType = Pick<
  CollectionEntry<"project">["data"]["img"][0],
  "src" | "alt"
>;

const { project } = Astro.props;
const { data } = project;
const { name, img, timeline } = data;
const { Content } = await render(project);

const optimizedImages =
  img?.map((image: ImageType) => {
    const needsSlash = typeof image.src === "string" && !image.src.startsWith("/");
    return {
      ...image,
      src: needsSlash ? `/${image.src}` : image.src,
    };
  }) || [];
---

<div class="group/project project-timeline-item pt-[var(--space-2xl)] flex flex-col gap-[var(--space-xl)]">
  {optimizedImages.length > 0 && (
    <div class="flex flex-col gap-[var(--space-xl)]">
      {optimizedImages.map((image: ImageType) => (
        <div class="media-wrapper flex items-center justify-center max-w-full mx-auto overflow-hidden origin-top">
          <div class="image-frame relative rounded-[12px] overflow-hidden max-w-[1000px] w-full transition-all duration-[400ms] ease-[cubic-bezier(0.4,0,0.2,1)] group-hover/project:-translate-y-1 group-hover/project:scale-[1.02]">
            <Image
              src={image.src}
              alt={image.alt}
              width={800}
              height={600}
              loading="lazy"
              class="project-image w-full h-auto max-w-[1000px] max-h-[600px] object-cover aspect-[4/3] transition-transform duration-700 ease-[cubic-bezier(0.4,0,0.2,1)] group-hover/project:scale-[1.05]"
            />
            <div class="image-overlay absolute inset-0 bg-[linear-gradient(135deg,rgba(0,0,0,0.1)_0%,rgba(0,0,0,0.05)_50%,rgba(255,255,255,0.1)_100%)] opacity-0 transition-opacity duration-[400ms] ease-in-out pointer-events-none group-hover/project:opacity-30"></div>
          </div>
        </div>
      ))}
    </div>
  )}

  <div class="sticky-content py-[var(--space-2xl)] sticky bottom-0 self-end basis-full bg-gradient-to-t from-[#1a1a1a] to-transparent">
    <div class="timeline-badge mb-[var(--space-s)]">
      <time class="timeline-date text-[color:var(--color-secondary)] opacity-90 font-semibold text-[0.9rem] uppercase tracking-[0.5px]">
        <span aria-hidden="true" class="inline-block w-[6px] h-[6px] bg-[color:var(--color-secondary)] rounded-full mr-2 align-middle group-hover/project:animate-[pulse_1.5s_infinite]"></span>
        {`${formatDate(new Date(timeline.start))} - ${!timeline.end ? "Current" : formatDate(new Date(timeline.end))}`}
      </time>
    </div>
    <h2 class="project-title mt-[var(--space-xs)] mb-[var(--space-s)] text-white font-bold leading-tight text-[clamp(1.5rem,2.5vw,2.5rem)]">
      {name}
    </h2>
    <div class="project-description prose-article">
      <Content />
    </div>
  </div>
</div>
