---

---

<div id="cmdk-overlay" hidden>
  <div id="cmdk-backdrop"></div>
  <div id="cmdk-panel" role="dialog" aria-modal="true">
    <div class="cmdk-header">
      <input
        id="cmdk-input"
        type="text"
        placeholder="Search projects, pages..."
        autocomplete="off"
        spellcheck="false"
        aria-label="Search"
      />
    </div>
    <ul id="cmdk-list" role="listbox"></ul>
  </div>
</div>

<style>
  #cmdk-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
  }

  #cmdk-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(44, 36, 28, 0.4);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 180ms ease;
  }

  #cmdk-panel {
    position: absolute;
    left: 50%;
    top: 15%;
    transform: translateX(-50%) scale(0.96);
    width: min(600px, calc(100% - 2rem));
    border-radius: var(--radius-lg);
    border: 1px solid var(--wc-sand);
    background: linear-gradient(180deg, var(--wc-cream) 0%, var(--wc-parchment) 100%);
    color: var(--wc-ink);
    box-shadow:
      var(--shadow-xl),
      inset 0 1px 0 rgba(255, 255, 255, 0.5);
    opacity: 0;
    transition:
      transform 200ms var(--ease-bounce),
      opacity 180ms ease;
  }

  .cmdk-header {
    padding: 1rem;
    border-bottom: 1px solid var(--wc-sand);
  }

  #cmdk-input {
    width: 100%;
    padding: 0.875rem 1rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--wc-sand);
    background: var(--wc-parchment);
    color: var(--wc-ink);
    font-family: var(--font-body);
    font-size: 1rem;
    outline: none;
    transition:
      border-color var(--duration-fast) var(--ease-smooth),
      box-shadow var(--duration-fast) var(--ease-smooth);
  }

  #cmdk-input:focus {
    border-color: var(--wc-accent);
    box-shadow: 0 0 0 3px var(--wc-accent-muted);
  }

  #cmdk-input::placeholder {
    color: var(--wc-bark);
    opacity: 0.6;
  }

  #cmdk-list {
    list-style: none;
    margin: 0;
    padding: 0.5rem;
    max-height: min(50vh, 400px);
    overflow: auto;
  }

  #cmdk-list li {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-family: var(--font-body);
    color: var(--wc-espresso);
    transition:
      background var(--duration-fast) var(--ease-smooth),
      color var(--duration-fast) var(--ease-smooth);
  }

  #cmdk-list li:hover {
    background: var(--wc-sand);
  }

  #cmdk-list li[aria-selected="true"] {
    background: var(--wc-accent-muted);
    color: var(--wc-ink);
  }

  #cmdk-list .meta {
    font-size: 0.8rem;
    color: var(--wc-bark);
    opacity: 0.7;
  }

  #cmdk-list li[aria-selected="true"] .meta {
    color: var(--wc-accent-deep);
    opacity: 1;
  }

  @media (prefers-reduced-motion: reduce) {
    #cmdk-backdrop,
    #cmdk-panel {
      transition: none;
    }
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const overlay = document.getElementById("cmdk-overlay");
    const backdrop = document.getElementById("cmdk-backdrop");
    const panel = document.getElementById("cmdk-panel");
    const input = document.getElementById("cmdk-input") as HTMLInputElement;
    const list = document.getElementById("cmdk-list");

    let openState = false;
    let selected = 0;
    let items: Array<{ label: string; url: string; meta: string }> = [];
    let prevActive: HTMLElement | null = null;

    const staticItems = [
      { label: "Home", url: "/", meta: "Page" },
      { label: "Projects", url: "/#projects-list-start", meta: "Page" },
      { label: "About", url: "/about", meta: "Page" },
      {
        label: "GitHub",
        url: "https://github.com/JoeriKaiser",
        meta: "External",
      },
      {
        label: "LinkedIn",
        url: "https://www.linkedin.com/in/joeri-kaiser",
        meta: "External",
      },
    ];

    const projects =
      (window.__PROJECTS && Array.isArray(window.__PROJECTS) && window.__PROJECTS) || [];
    const projectItems = projects.map((p) => ({
      label: p.name,
      url: p.url,
      meta: "Project",
    }));

    items = [...projectItems, ...staticItems];

    const render = (rows: Array<{ label: string; url: string; meta: string }>) => {
      if (!list) return;
      list.innerHTML = "";
      rows.forEach((row, i) => {
        const li = document.createElement("li");
        li.setAttribute("role", "option");
        li.setAttribute("aria-selected", String(i === selected));
        li.dataset.url = row.url;
        li.innerHTML = `<span>${row.label}</span><span class="meta">${row.meta}</span>`;
        li.addEventListener("mousemove", () => {
          selected = i;
          updateSelection();
        });
        li.addEventListener("click", () => {
          navigate(row.url);
        });
        list.appendChild(li);
      });
    };

    const updateSelection = () => {
      const children = Array.from(list?.children ?? []);
      children.forEach((el, i) => {
        el.setAttribute("aria-selected", String(i === selected));
        if (i === selected) {
          el.scrollIntoView({ block: "nearest" });
        }
      });
    };

    const normalize = (s: string) => s.toLowerCase();
    const filter = (q: string) => {
      const n = normalize(q);
      if (!n) {
        return items.slice(0, 30);
      }
      return items.filter((it) => normalize(it.label).includes(n)).slice(0, 30);
    };

    const navigate = (url: string) => {
      close();
      if (url.startsWith("http")) {
        window.open(url, "_blank", "noopener,noreferrer");
      } else {
        window.location.href = url;
      }
    };

    const open = () => {
      if (openState) return;
      if (!overlay || !backdrop || !panel || !input) return;
      openState = true;
      prevActive = document.activeElement as HTMLElement;
      overlay.hidden = false;
      requestAnimationFrame(() => {
        backdrop.style.opacity = "1";
        panel.style.opacity = "1";
        panel.style.transform = "translateX(-50%) scale(1)";
        input.focus();
      });
      const q = input.value || "";
      selected = 0;
      render(filter(q));
    };

    const close = () => {
      if (!openState) return;
      if (!overlay || !backdrop || !panel) return;
      openState = false;
      backdrop.style.opacity = "0";
      panel.style.opacity = "0";
      panel.style.transform = "translateX(-50%) scale(0.96)";
      setTimeout(() => {
        overlay.hidden = true;
      }, 200);
      if (prevActive && prevActive.focus) {
        prevActive.focus();
      }
    };

    window.addEventListener("open-command-palette", open);
    backdrop?.addEventListener("click", close);
    window.addEventListener("keydown", (e) => {
      if (!openState && (e.key === "Escape" || e.key === "Esc")) return;
      if (openState && e.key === "Escape") {
        e.preventDefault();
        close();
      }
    });

    input.addEventListener("input", () => {
      const q = input.value;
      selected = 0;
      render(filter(q));
    });

    input.addEventListener("keydown", (e) => {
      const rows = Array.from(list?.children ?? []);
      if (e.key === "ArrowDown") {
        e.preventDefault();
        selected = Math.min(rows.length - 1, selected + 1);
        updateSelection();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        selected = Math.max(0, selected - 1);
        updateSelection();
      } else if (e.key === "Enter") {
        e.preventDefault();
        const el = rows[selected] as HTMLElement;
        if (el) {
          const url = el.dataset.url || "/";
          navigate(url);
        }
      }
    });
  });
</script>
